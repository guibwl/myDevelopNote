# 创建流水线流程(标准流程)

- 本文档以健康管理前端项目为例，接入神兵的前端工程可以选择性参照本文档创建流水线;
- 工程目录结构需与[健康管理前端工程](http://code.**.com.cn/static-pool/health-manage.git)保持一致，可以复制该仓库代码，并直接在`packages/`目录下面创建工程，若缺少权限请联系 liuyuan076@**.com.cn;
- `packages/` 目录内的所有工程必须使用 `npm run build` 命令打包，打包目标目录为 `dist/`；

## 第一步，添加模块

> 如果之前已经配置过模块，请直接从第二步开始；

打开配置模块页面：
http://alm.**.com.cn/project/14850/setting/?page#/project
![屏幕快照 2020-07-13 上午10.46.57.png](http://wb.**.com.cn/file/uid/55617edc8de344ebbd3e6a9d3e2ef182)

页面找到如上图位置，点击新增模块，弹出如下窗口；
![屏幕快照 2020-07-13 上午11.40.33.png](http://wb.**.com.cn/file/uid/03453ef9ca2b40ac8dd656396d2448a1)

- 模块名：<项目名称>/<工程名称>
    > ⚠️发布后页面访问地址是根据模块名决定的，如：'https://test1-city.**.com.cn/static/public-src/<模块名>/'；所以这里命名一定要规范，且避免重复；推荐如上图的例子命名使用两级目录来进行管理：<项目名称: health-manage>/<工程名称: COPD-health-questionnaire>；
- 部署类型：应用部署
- 代码库：选择 GIT，输入代码仓库(如：http://code.**.com.cn/static-pool/health-manage.git)

完成输入后点击确定；

## 第二步，给版本添加模块

打开版本页面：
http://alm.**.com.cn/project/14850/menu?name=plan#/release

![屏幕快照 2020-07-13 上午10.56.35.png](http://wb.**.com.cn/file/uid/ef1946e686f84e4192fe35e5aa4fa99c)

如上图，左菜单选中当前发布的版本（本例中选 SIAPP-STATICPOOL0.0.03），在页面右边部分找到‘添加模块’，选中我们刚才创建的模块，然后点击‘确定’。

之后我们会在页面上看到新增的模块，如下图：

![屏幕快照 2020-07-13 上午11.01.29.png](http://wb.**.com.cn/file/uid/c13cad55313b4a1da1d7b636e0831c93)

这里我们需要配置：
- 分支：需要发布的分支，一般是 develop
- 子目录：packages/<packages目录下对应的工程目录名>/
> 注意这里是有斜杠结尾的

配置完成后，点击页面右上角，‘去部署’按钮；

## 第三步，配置流水线

点击 ‘去部署’按钮后，打开流水线配置页面，在页面中找到刚才配置的模块，并点击‘快速配置’；

![屏幕快照 2020-07-13 上午11.14.50.png](http://wb.**.com.cn/file/uid/cc4174149b68417892f6fcd4c2dee4ce)
>  注意，这里名称过长，需要鼠标悬浮才能看全称，如果觉得麻烦，可以点击当前页面右上角‘查看全部’按钮查看完整名称的流水线列表，列表中‘设置’按钮等同于‘快速配置’按钮；

</br>

如果已经配置过了，或者执行过了流水，那么这里将鼠标悬浮'...'来弹出‘配置流水线’入口，如下图：
![屏幕快照 2020-07-15 上午11.00.41.png](http://wb.**.com.cn/file/uid/73b423e875be43a9b56ee5e76700d4c5)

</br>

#### 流水线设置

![1.png](http://wb.**.com.cn/file/uid/2ffae0f922024673ad0813102d1909aa)

点击‘快速配置’后，打开如上页面；

点击第一个红框下的‘+添加新参数’，添加动态参数：
- key: __delete__
- value: <需要删除的目录或文件>/
> 注意这里 value 是有斜杠结尾的；因为我们是增量部署，这个参数是用来告诉服务器，咱们需要在部署前，删除服务器上面哪些文件；多个目录或文件可以用','号隔开。

然后，点击第二个红框中的下箭头，打开折叠内容，这里我们找到 Url 一项勾选‘自动触发’即可，如下图：

![2.png](http://wb.**.com.cn/file/uid/37af60a927144db9a1cd72a9f605591d)

</br>

#### 编译设置

回到页面顶部，我们点击‘编译按钮’：

![屏幕快照 2020-07-13 上午11.35.39.png](http://wb.**.com.cn/file/uid/1d1c294cef194bf58906b1e8dfb3c601)

在成功通过条件中，点击‘X’去掉DB审计一项，如下图：
![屏幕快照 2020-07-13 上午11.36.23.png](http://wb.**.com.cn/file/uid/d1f7f24355ad4b6b85833c3ab0291e7b)

然后这一步还有三个地方修改，如下图：

![屏幕快照 2020-07-13 上午11.43.25.png](http://wb.**.com.cn/file/uid/75257e38d637459aad2f55839176eb87)

上图修改的三个点如下：

- deployflow 文件： packages/<packages目录下的工程目录名>/deploy_desc/deployflow.properties
- 编译前脚本：请完整复制如下代码
     ```sh
     #!bin/bash
     sh "packages/"${vt2_pipeline_name#*\/}/deploy_desc/deploy.task.sh
     ```
- 移交脚本：请清空该输入框内所有代码；

</br>

#### STG 部署设置

回到页面顶部，点击‘STG部署’：
![屏幕快照 2020-07-13 上午11.50.12.png](http://wb.**.com.cn/file/uid/877eca7eb42a4b9e8d0a6cf448b416e8)
在这里找到如下图设置:
- 执行方式：自动；
- 部署环境: siapp_staticpool_stg1;
![12345.png](http://wb.**.com.cn/file/uid/e372cbd3781e48f7a6901325e6288b44)
最后点击右上角，‘保存并启用’ 按钮，完成流水线配置；

## 第四步，发布及验证

上一步操作后，会回到流水线列表页面，点击‘执行’或‘重新执行’按钮，进行发布；
![4.png](http://wb.**.com.cn/file/uid/5d476a682a904987a5c556779efc48f6)

按照显示的发布进度，发布成功后，访问相应页面进行验证。

访问页面地址：
```sh
'https://test1-city.**.com.cn/static/public-src/<模块名>/'；
```
<模块名>对应第一步中你创建的模块名。再后面添加你对应部署的资源文件名即可访问对应资源。


