# 神兵迁移-操作流程-健康管理

因为项目繁多，所以我们挑选出核心的项目分批次进行迁移；整个过程我们把迁移分为 6 步来进行；下面我们从迁移的前置材料和分步操作逐步来看下；

### 仓库及空间
- siapp-staticpool 神兵空间地址：
http://alm.**.com.cn/project/14850/menu?name=plan#/release

- 旧代码仓库：
http://code.**.com.cn/#/repo/static-pool/foundation/develop/null/tree

- 新代码仓库：
http://code.**.com.cn/#/repo/static-pool/health-manage/develop/tree

### 迁移清单
见底部附件 Excel

</br>

### 第一步，代码仓库迁移

我们的迁移第一步是将工程从旧的代码仓库迁移到新的代码仓库；
以下表为例：

| 批次 | 工程地址 | 功能 | 迁移地址（神兵） | 迁移工作量 | 注释 |
| ---- | -------- | ---- | ---------------- | ---------- | ---- |
| 第一批(HealthPlatform/) |HealthPlatform/reList |健康报告生成子流程-健康报告列表 |health-report-list | | |

**工程地址**：对应的是我们旧仓库的目录；
 **迁移地址（神兵）**： 对应的是我们新仓库里的工程文件夹名称；迁移的目录则是 'packages/' + 工程文件夹名称；比如下表对应的目录在新仓库中即'packages/health-report-list'

> ⚠️ 你可以在目前已存在的 'packages/health-main' 目录中，看到一个 'deploy_desc' 文件夹，请把它复制到每一个你迁移的工程根目录里面；

现在我们可以开始迁移工作，迁移的完整清单，请下载 Excel。

</br>

### 第二步，旧项目做重定向

请直接在旧的项目代码里，修改打包后的 index.html，请删除里面无用的资源请求和代码逻辑，仅保留重定向的代码；
重定向的目标地址即是迁移后的页面访问地址；

示例：

```html
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head lang="en">
    <script type="text/javascript">
        location.replace(
          window.location.origin +
          '/static/public-src/health-manage/<迁移地址(神兵)>/index.html' +
          window.location.search +
          window.location.hash
        );
    </script>
   </head>
</html>
```
对于上面重定向的地址`'/static/public-src/health-manage/<迁移地址(神兵)>/index.html'`不太清除的，可以查看第六步的解释；

</br>

### 第三步，修改内部打包目录

之前我们因为要将打包文件上传到代码仓库，所以我们统一使用 webapp 作为打包的目录名称；迁移神兵后，我们将使用神兵的打包机，自动化打包，无需再手动打包上传，所以我们不再需要 webapp 了，我们需要统一把工程的打包目录名改成 dist；

这里其实就是统一修改下 webpack 的配置，我们先找到 webpack 配置文件，然后修改配置中的 output.path 属性即可；

以旧仓库中目录 HealthPlatform/reList 的工程为例，我们在 build/ 目录中 找到 webpack 配置文件 webpack.config.js，找到 output 属性：

```js
  output: {
    path: path.resolve(basePath, "./webapp"), 
    chunkFilename: "static/js/[name].[chunkhash:12].js",
    filename: "[name].[chunkhash:12].js"
  },
```
这里我们直接把 output.path 中 'webapp' 这部分字符改为 'dist' 即可；

</br> 

### 第四步，跳转地址，统一使用JSSDK提供的方法

这一步请确保工程内都加载了JSSDK  `foundation/pamSdk/dist/**medical-0.0.0-min.js` ，如果不清楚这一步，可以问下组里的其他前端同学或者参照旧仓库`HealthPlatform/healthIndex/build/index.html`文件。

> 健康管理师端不使用统一的JSSDK，沿用自身提供的方法。

我们需要将所有 test1-city.**.com.cn、city.**.com.cn、test-mhis-siapp.**.com.cn 域名下的页面跳转URL，都使用统一方法进行拼接。

在我们各自负责迁移的工程内，全局搜索 `/static/`，注意排除掉 `node_modules/,webapp/,dist/` 这些无需搜索的目录。
检查每一项搜索出来的用于跳转的URL，包括但不限于以下用于跳转的 URL：

```js
var url = `${window.location.origin}/static/foundation/found_resident/wechatLogin/build/index.html?';
window.location.href = url;
```
```js
var url = `${currHost}/static/foundation/healthFamily/healthCard-Detail/webapp/index.html`;
window.location.href = url;
```
将搜出来用于跳转的 URL 表示域名的部分替换为 `window.JSPAMSDK.domain()`，例如上面第一条URL改为：

```js
url = `${window.JSPAMSDK.domain()}/static/foundation/found_resident/wechatLogin/build/index.html?';
window.location.href = url;
```

</br>

### 第五步，请求方法，统一使用JSSDK提供的方法

> 健康管理师端不使用统一的JSSDK，沿用自身提供的方法。

这一步是坑比较多的地方，可能有些工程本地封装的老方法，和现在用的不太一样，需要小伙伴们尽可能查看本地封装的请求方法和JSSDK的请求方法有是否一致，是否可用，修改的话，要修改哪里，比如 header 或者 body 的传参方式可能不同；

这里如果不一样的话，需要小伙伴们对本地的请求进行二次封装，以适应 JSSDK 中的请求方法；

JSSDK 中的请求方法通过 `window.JSPAMSDK.fetch` 访问；

</br>

### 第六步，所有跳转地址，都更换为迁移后的地址

更新模块后，所有跳转老的发布地址的跳转，都更新为新的跳转；
**跳转地址对应‘迁移清单’ Excel 中的 ‘迁移地址(神兵)’**，那么迁移后的完整地址访问路径为：
```sh
https://test1-city.**.com.cn/static/public-src/health-manage/<迁移地址(神兵)>/index.html
```
